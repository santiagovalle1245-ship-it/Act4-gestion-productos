<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mis Productos</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #007bff; color: white; }
        input { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <h2>Gestión de Productos</h2>
    
    <div class="card">
        <h3>Agregar Nuevo Producto</h3>
        <input type="text" id="nombre" placeholder="Nombre (ej. Laptop)">
        <input type="text" id="desc" placeholder="Descripción">
        <input type="number" id="precio" placeholder="Precio">
        <button onclick="agregarProducto()">Guardar Producto</button>
    </div>

    <table id="tablaProductos">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Precio</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        const token = localStorage.getItem('token'); 

    // 1. Función para cargar productos con manejo de errores
    async function cargarProductos() {
        try {
            const res = await fetch('/api/products', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!res.ok) {
                console.error("Error del servidor al cargar:", res.status);
                return;
            }

            const productos = await res.json();
            // Verificamos si lo que llegó es una lista (Array)
            if (!Array.isArray(productos)) {
                console.log("No se recibieron productos o el formato es incorrecto");
                return;
            }

            const cuerpoTabla = document.querySelector('#tablaProductos tbody');
            cuerpoTabla.innerHTML = ""; 
            
            productos.forEach(p => {
                cuerpoTabla.innerHTML += `<tr><td>${p.name}</td><td>${p.description}</td><td>$${p.price}</td></tr>`;
            });
        } catch (error) {
            console.error("Error de conexión:", error);
        }
    }

    // 2. Función para agregar producto con verificación real
    async function agregarProducto() {
        const nombre = document.getElementById('nombre').value;
        const descripcion = document.getElementById('desc').value;
        const precio = document.getElementById('precio').value;

        try {
            const res = await fetch('/api/products', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                },
                // IMPORTANTE: Convertimos el precio a Número real para MongoDB
                body: JSON.stringify({ 
                    name: nombre, 
                    description: descripcion, 
                    price: Number(precio) 
                })
            });

            const data = await res.json();

            if (res.ok) {
                alert("¡Guardado exitosamente en la nube!");
                cargarProductos(); 
            } else {
                // Si el servidor rechaza, nos dirá por qué (ej. Token inválido)
                alert("El servidor rechazó el producto: " + (data.mensaje || "Error desconocido"));
                console.log("Detalle del error:", data);
            }
        } catch (error) {
            alert("Error de red: No se pudo contactar al servidor.");
        }
    }

    cargarProductos();
    </script>
</body>
</html>
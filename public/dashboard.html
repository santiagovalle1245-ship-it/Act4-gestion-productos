<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mis Productos</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #007bff; color: white; }
        input { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <h2>Gestión de Productos</h2>
    
    <div class="card">
        <h3>Agregar Nuevo Producto</h3>
        <input type="text" id="nombre" placeholder="Nombre (ej. Laptop)">
        <input type="text" id="desc" placeholder="Descripción">
        <input type="number" id="precio" placeholder="Precio">
        <button onclick="agregarProducto()">Guardar Producto</button>
    </div>

    <table id="tablaProductos">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Precio</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        // 1. Verificación inmediata al entrar: si no hay token, lo mandamos al login al instante
        const token = localStorage.getItem('token');
        
        if (!token || token === "undefined") {
            console.error("TOKEN PERDIDO O INVÁLIDO");
            alert("Tu sesión no es válida. Por favor inicia sesión de nuevo.");
            window.location.href = 'login.html';
        }

        async function cargarProductos() {
            try {
                const res = await fetch('/api/products', {
                    headers: { 'Authorization': `Bearer ${token}` } 
                });
                
                // Si el servidor nos rechaza (401), lanzamos un error para ir al login
                if (res.status === 401) throw new Error("Sesión expirada");

                const productos = await res.json();
                const cuerpoTabla = document.querySelector('#tablaProductos tbody');
                cuerpoTabla.innerHTML = ""; 
                
                productos.forEach(p => {
                    cuerpoTabla.innerHTML += `<tr><td>${p.name}</td><td>${p.description}</td><td>$${p.price}</td></tr>`;
                });
            } catch (e) {
                console.log("Sesión inválida o error, redirigiendo...");
                window.location.href = 'login.html';
            }
        }

        async function agregarProducto() {
            const name = document.getElementById('nombre').value;
            const description = document.getElementById('desc').value;
            const price = document.getElementById('precio').value;

            if (!name || !price) {
                alert("Por favor llena el nombre y el precio.");
                return;
            }

            const res = await fetch('/api/products', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify({ name, description, price: Number(price) })
            });

            if (res.ok) {
                alert("¡Guardado en MongoDB!");
                cargarProductos(); // Refrescamos la tabla
            } else {
                const error = await res.json();
                alert("Error: " + (error.mensaje || "No se pudo guardar"));
                if (res.status === 401) window.location.href = 'login.html';
            }
        }

        // Cargamos la tabla apenas abre la página
        cargarProductos();
    </script>
</body>
</html>
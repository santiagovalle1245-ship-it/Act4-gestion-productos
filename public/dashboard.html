<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mis Productos</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #007bff; color: white; }
        input { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <h2>Gestión de Productos</h2>
    
    <div class="card">
        <h3>Agregar Nuevo Producto</h3>
        <input type="text" id="nombre" placeholder="Nombre (ej. Laptop)">
        <input type="text" id="desc" placeholder="Descripción">
        <input type="number" id="precio" placeholder="Precio">
        <button onclick="agregarProducto()">Guardar Producto</button>
    </div>

    <table id="tablaProductos">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Precio</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        // Esta función busca el token en el almacenamiento en el momento exacto que se necesita
    function obtenerToken() {
        const t = localStorage.getItem('token');
        if (!t) {
            console.error("Token no encontrado en localStorage");
        }
        return t;
    }

    async function cargarProductos() {
        const tokenActual = obtenerToken();
        if (!tokenActual) {
            alert("No hay sesión activa. Regresando al Login...");
            window.location.href = 'login.html';
            return;
        }

        try {
            const res = await fetch('/api/products', {
                headers: { 'Authorization': `Bearer ${tokenActual}` }
            });
            
            const productos = await res.json();
            if (res.ok) {
                const cuerpoTabla = document.querySelector('#tablaProductos tbody');
                cuerpoTabla.innerHTML = ""; 
                productos.forEach(p => {
                    cuerpoTabla.innerHTML += `<tr><td>${p.name}</td><td>${p.description}</td><td>$${p.price}</td></tr>`;
                });
            } else {
                console.log("Error al cargar lista:", productos.mensaje);
            }
        } catch (e) { console.log("Error de conexión"); }
    }

    async function agregarProducto() {
        const tokenActual = obtenerToken(); // Validamos el token justo antes de guardar
        const name = document.getElementById('nombre').value;
        const description = document.getElementById('desc').value;
        const price = document.getElementById('precio').value;

        if (!name || !price) {
            alert("Por favor llena los campos obligatorios.");
            return;
        }

        try {
            const res = await fetch('/api/products', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${tokenActual}` 
                },
                body: JSON.stringify({ name, description, price: Number(price) })
            });

            const data = await res.json();
            if (res.ok) {
                alert("¡Producto guardado!");
                cargarProductos();
            } else {
                // Si sale el error de "No hay token", lo veremos aquí
                alert("Error: " + (data.mensaje || "Token inválido o expirado"));
                if (res.status === 401) window.location.href = 'login.html';
            }
        } catch (e) { alert("Error de red"); }
    }

    cargarProductos();
    </script>
</body>
</html>